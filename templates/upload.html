{% extends "base.html" %}
{% block title %}上传视频 - MouseScope{% endblock %}
{% block content %}
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="cyber-text mb-0" data-i18n="upload.title">视频文件上传</h5>
            </div>
            <div class="card-body">
                <ul class="nav nav-tabs mb-4" id="uploadMethodTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="web-upload-tab" data-bs-toggle="tab"
                            data-bs-target="#web-upload" type="button" role="tab"><span data-i18n="upload.tab.web">网页上传</span></button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="local-path-tab" data-bs-toggle="tab" data-bs-target="#local-path"
                            type="button" role="tab"><span data-i18n="upload.tab.local">服务器本地路径</span></button>
                    </li>
                </ul>

                <form method="POST" action="{{ url_for('do_upload') }}" enctype="multipart/form-data" id="uploadForm">
                    <div class="tab-content" id="uploadMethodContent">
                        <div class="tab-pane fade show active" id="web-upload" role="tabpanel">
                            <div class="upload-zone-compact" id="dropZone">
                                <div class="text-center">
                                    <h4 data-i18n="upload.drop.hint">拖拽文件到这里</h4>
                                    <p class="text-muted mb-3" data-i18n="upload.drop.or">或点击选择文件</p>
                                    <input type="file" class="d-none" id="video" name="videos"
                                        accept=".mp4,.avi,.mov,.mkv,.wmv" multiple>
                                    <span class="d-none" data-i18n="upload.status.ready">Ready to upload</span>
                                    <span class="d-none" data-i18n="upload.status.uploading">Uploading</span>
                                    <span class="d-none" data-i18n="upload.status.files">个文件</span>
                                    <span class="d-none" data-i18n="upload.status.done">个文件已上传</span>
                                    <button type="button" class="btn btn-primary" onclick="document.getElementById('video').click()"><span data-i18n="upload.btn.select">选择文件</span></button>
                                </div>
                            </div>
                        </div>

                        <div class="tab-pane fade" id="local-path" role="tabpanel">
                            <div class="alert alert-info">
                                <strong data-i18n="upload.local.tip.title">提示:</strong><br>
                                <span data-i18n="upload.local.tip.body" data-i18n-html>可以直接<strong>拖拽视频文件</strong>到下方区域，或手动输入服务器上的完整路径</span><br>
                                <small>• <span data-i18n="upload.local.bullet1">拖拽文件：自动上传并填入路径</span></small><br>
                                <small>• <span data-i18n="upload.local.bullet2">手动输入：支持文件路径和文件夹路径，每行一个</span></small><br>
                                <small>• <span data-i18n="upload.local.bullet3">文件夹：自动扫描并批量处理文件夹下所有视频</span></small>
                            </div>

                            <div class="local-drop-zone" id="localDropZone">
                                <div class="text-center">
                                    <h5 data-i18n="upload.local.drag.hint">拖拽视频文件到这里</h5>
                                    <p class="text-muted mb-3" data-i18n="upload.local.drag.sub">支持 .mp4 .avi .mov .mkv .wmv 格式，可同时拖入多个文件</p>
                                    <input type="file" class="d-none" id="localFileInput"
                                        accept=".mp4,.avi,.mov,.mkv,.wmv" multiple>
                                    <button type="button" class="btn btn-outline-info" onclick="document.getElementById('localFileInput').click()"><span data-i18n="upload.local.or.select">或点击选择文件</span></button>
                                </div>
                                <div id="localUploadProgress" class="mt-3" style="display: none;">
                                    <div class="progress">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" id="localProgressBar" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted d-flex align-items-center mt-2" id="localUploadStatus"><i class="fas fa-spinner fa-spin me-2"></i><span data-i18n="upload.uploading">上传中...</span></small>
                                </div>
                            </div>

                            <div class="text-center my-3">
                                <span class="text-muted" data-i18n="upload.local.or.input">── 或手动输入路径 ──</span>
                            </div>

                            <div class="mb-3">
                                <label for="localPaths" class="form-label" data-i18n="upload.local.label">视频文件/文件夹路径</label>
                                <textarea class="form-control font-monospace" id="localPaths" name="local_paths"
                                    rows="6" data-i18n="upload.local.placeholder" data-i18n-attr="placeholder"
                                    placeholder="例如：&#10;/data/videos/mouse1.mp4&#10;/data/videos/batch1/"></textarea>
                            </div>
                            <button type="button" class="btn btn-outline-primary" id="validatePathsBtn"><span data-i18n="upload.validate">验证路径</span></button>
                        </div>
                    </div>

                    <div id="fileList" class="mt-4"></div>
                    <div id="configSection" class="mt-4" style="display: none;">
                        <div class="card">
                            <div class="card-body">
                                <h6 class="cyber-text mb-3" data-i18n="upload.config.title">分析配置</h6>
                                <div class="row g-3 mb-3">
                                    <div class="col-md-6">
                                        <label class="form-label" data-i18n="upload.config.start">开始秒数（可选）</label>
                                        <input type="number" step="0.1" min="0" class="form-control"
                                            name="start_seconds" placeholder="0.0">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label" data-i18n="upload.config.end">结束秒数（可选）</label>
                                        <input type="number" step="0.1" min="0" class="form-control" name="end_seconds"
                                            placeholder="">
                                        <div class="form-text" data-i18n="upload.config.end.hint">填写则只分析该时间段</div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label" data-i18n="upload.config.outdir">输出文件夹（可选）</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control font-monospace" name="output_dir"
                                            id="outputDir"
                                            data-i18n="upload.config.outdir.ph" data-i18n-attr="placeholder"
                                            placeholder="留空则使用默认目录: data/results/">
                                        <button type="button" class="btn btn-outline-info" onclick="setDefaultOutputDir()">
                                            <i class="fas fa-undo me-1"></i><span data-i18n="upload.config.default">默认</span>
                                        </button>
                                    </div>
                                    <div class="form-text" data-i18n="upload.config.outdir.hint">桌面端专属：分析结果将直接保存到此文件夹，可用文件管理器直接查看</div>
                                </div>
                                <div class="d-grid">
                                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn"><span data-i18n="upload.config.submit">开始分析配置</span></button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="cyber-text mb-0" data-i18n="upload.side.title">实验信息</h6>
            </div>
            <div class="card-body">
                <div class="text-center mb-3">
                    <h6 class="text-primary" data-i18n="upload.side.tst">悬尾实验</h6>
                    <small class="text-muted" data-i18n="upload.side.tst.en">Tail Suspension Test</small>
                </div>
                <div class="alert alert-info">
                    <strong data-i18n="upload.side.tip">拍摄要求:</strong><br>
                    <span data-i18n="upload.side.tip.body">确保小鼠完全悬挂，背景静止，光照均匀</span>
                </div>
                <div class="flow-steps">
                    <span class="flow-step active" data-i18n="upload.step1">1.上传</span>
                    <i class="fas fa-chevron-right flow-arrow"></i>
                    <span class="flow-step" data-i18n="upload.step2">2.标定</span>
                    <i class="fas fa-chevron-right flow-arrow"></i>
                    <span class="flow-step" data-i18n="upload.step3">3.分析</span>
                    <i class="fas fa-chevron-right flow-arrow"></i>
                    <span class="flow-step" data-i18n="upload.step4">4.结果</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('video');
        const fileList = document.getElementById('fileList');
        const configSection = document.getElementById('configSection');

        if (fileInput) {
            fileInput.addEventListener('change', function (e) {
                if (e.target.files.length > 0) handleFiles(e.target.files);
            });
        }

        if (dropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt =>
                dropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(evt =>
                dropZone.addEventListener(evt, () => dropZone.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(evt =>
                dropZone.addEventListener(evt, () => dropZone.classList.remove('dragover'), false));
            dropZone.addEventListener('drop', e => {
                fileInput.files = e.dataTransfer.files;
                handleFiles(e.dataTransfer.files);
            }, false);
        }

        function handleFiles(files) {
            if (files.length > 0) {
                const totalSize = Array.from(files).reduce((s, f) => s + f.size, 0);
                const readyText = document.querySelector('[data-i18n="upload.status.ready"]') ? document.querySelector('[data-i18n="upload.status.ready"]').textContent : 'Ready to upload';
                fileList.innerHTML = `
                <div class="alert alert-success d-flex align-items-center">
                    <i class="fas fa-check-circle me-2 fs-5"></i>
                    <div class="flex-grow-1">
                        <strong>${readyText}</strong> — ${files.length} <span data-i18n="upload.status.files">个文件</span>
                        <div class="small text-muted mt-1">${Array.from(files).map(f => f.name).slice(0, 3).join(', ')}${files.length > 3 ? '...' : ''}</div>
                    </div>
                    <span class="badge bg-success">${(totalSize / 1024 / 1024).toFixed(1)} MB</span>
                </div>`;
                configSection.style.display = 'block';
            }
        }

        const validateBtn = document.getElementById('validatePathsBtn');
        if (validateBtn) {
            validateBtn.addEventListener('click', function () {
                const paths = document.getElementById('localPaths').value.trim();
                const msgEmpty = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.validate.empty'] : '请输入至少一个路径';
                if (!paths) { alert(msgEmpty); return; }
                const lines = paths.split('\n').filter(p => p.trim());
                const msgSuccess = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.validate.success'].replace('{}', lines.length) : lines.length + ' 个路径已输入';
                fileList.innerHTML = '<div class="alert alert-success"><strong>' + msgSuccess + '</strong></div>';
                configSection.style.display = 'block';
            });
        }

        // ====== 本地路径拖拽上传逻辑 ======
        const localDropZone = document.getElementById('localDropZone');
        const localFileInput = document.getElementById('localFileInput');

        if (localFileInput) {
            localFileInput.addEventListener('change', function (e) {
                if (e.target.files.length > 0) uploadLocalFiles(e.target.files);
            });
        }

        if (localDropZone) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt =>
                localDropZone.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false));
            ['dragenter', 'dragover'].forEach(evt =>
                localDropZone.addEventListener(evt, () => localDropZone.classList.add('dragover'), false));
            ['dragleave', 'drop'].forEach(evt =>
                localDropZone.addEventListener(evt, () => localDropZone.classList.remove('dragover'), false));
            localDropZone.addEventListener('drop', e => {
                const files = e.dataTransfer.files;
                if (files.length > 0) uploadLocalFiles(files);
            }, false);
        }

        function uploadLocalFiles(files) {
            const progressDiv = document.getElementById('localUploadProgress');
            const progressBar = document.getElementById('localProgressBar');
            const statusText = document.getElementById('localUploadStatus');
            const textarea = document.getElementById('localPaths');

            // 过滤视频文件
            const validExts = ['.mp4', '.avi', '.mov', '.mkv', '.wmv'];
            const videoFiles = Array.from(files).filter(f => {
                const ext = '.' + f.name.split('.').pop().toLowerCase();
                return validExts.includes(ext);
            });

            if (videoFiles.length === 0) {
                alert((typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.validate.novideo'] : '没有检测到支持的视频文件（.mp4 .avi .mov .mkv .wmv）');
                return;
            }

            progressDiv.style.display = 'block';
            progressBar.style.width = '0%';
            const uploadingLabel = document.querySelector('[data-i18n="upload.status.uploading"]') ? document.querySelector('[data-i18n="upload.status.uploading"]').textContent : 'Uploading';
            statusText.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i><span>${uploadingLabel} 0%</span>`;

            const formData = new FormData();
            videoFiles.forEach(f => formData.append('files', f));

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/upload_files', true);

            xhr.upload.onprogress = function (e) {
                if (e.lengthComputable) {
                    const pct = Math.round((e.loaded / e.total) * 100);
                    progressBar.style.width = pct + '%';
                    const uploadingLabel = document.querySelector('[data-i18n="upload.status.uploading"]') ? document.querySelector('[data-i18n="upload.status.uploading"]').textContent : 'Uploading';
                    statusText.innerHTML = `<i class="fas fa-spinner fa-spin me-2"></i><span>${uploadingLabel} ${pct}%</span>`;
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const result = JSON.parse(xhr.responseText);
                    if (result.success && result.paths.length > 0) {
                        // 将上传后的服务器路径追加到textarea
                        const currentPaths = textarea.value.trim();
                        const newPaths = result.paths.join('\n');
                        textarea.value = currentPaths ? currentPaths + '\n' + newPaths : newPaths;

                        progressBar.style.width = '100%';
                        progressBar.classList.remove('progress-bar-animated');
                        progressBar.classList.add('bg-success');
                        statusText.innerHTML = `<i class="fas fa-check-circle me-2 text-success"></i><span>${result.paths.length} <span data-i18n="upload.status.done">个文件已上传</span></span>`;

                        const msgUpload = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.upload.success'].replace('{}', result.paths.length) : result.paths.length + ' 个文件已上传并添加到路径列表';
                        fileList.innerHTML = '<div class="alert alert-success"><strong>' + msgUpload + '</strong><div class="small text-muted mt-1">' + result.paths.map(p => p.split('/').pop()).join(', ') + '</div></div>';
                        configSection.style.display = 'block';

                        setTimeout(() => {
                            progressDiv.style.display = 'none';
                            progressBar.classList.remove('bg-success');
                            progressBar.classList.add('progress-bar-animated');
                        }, 3000);
                    } else {
                        const pre = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.error.upload'] : '上传失败: ';
                        statusText.textContent = pre + (result.error || (getLang && getLang() === 'en' ? 'Unknown error' : '未知错误'));
                        progressBar.classList.add('bg-danger');
                    }
                } else {
                    statusText.textContent = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.error.retry'] : '上传失败，请重试';
                    progressBar.classList.add('bg-danger');
                }
            };

            xhr.onerror = function () {
                statusText.textContent = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.error.network'] : '网络错误，请检查连接后重试';
                progressBar.classList.add('bg-danger');
            };

            xhr.send(formData);
        }

        const localPathsInput = document.getElementById('localPaths');
        if (localPathsInput) {
            localPathsInput.addEventListener('blur', function () {
                const outputDirInput = document.getElementById('outputDir');
                if (outputDirInput && !outputDirInput.value.trim()) {
                    const lines = this.value.trim().split('\n').filter(p => p.trim());
                    if (lines.length > 0) {
                        const firstPath = lines[0].trim();
                        // 取第一个路径的父目录作为默认输出建议
                        const parts = firstPath.replace(/\\/g, '/').split('/');
                        parts.pop();
                        const parentDir = parts.join('/');
                        if (parentDir) {
                            const prefix = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.suggest.prefix'] : '建议: ';
                            outputDirInput.placeholder = prefix + parentDir + '/results/';
                        }
                    }
                }
            });
        }
    });

    function setDefaultOutputDir() {
        const out = document.getElementById('outputDir');
        out.value = '';
        out.placeholder = (typeof I18N !== 'undefined' && getLang) ? I18N[getLang()]['upload.config.outdir.ph'] : '留空则使用默认目录: data/results/';
    }
</script>

{% endblock %}